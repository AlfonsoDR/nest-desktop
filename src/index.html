<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <link rel='stylesheet' href='../node_modules/bootstrap/dist/css/bootstrap.min.css' />
    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.css" />
    <link rel='stylesheet' href='./assets/css/styles.css'></link>
    <title></title>
</head>

<body>
    <div id='message'>
        <div class='content'></div>
    </div>

    <div id='simulation-detail' class='modal fade' role='dialog'>
        <div class='modal-dialog'>
            <div class='modal-content'>
                <div class='modal-header'>
                    <button type='button' class='close' data-dismiss='modal' aria-label='Close'><span aria-hidden='true'>&times;</span></button>
                    <h4 class='modal-title'></h4>
                </div>
                <div class='modal-body'>
                    <div class='row'>
                        <div class='col-sm-6 col-md-4'>
                            <a class='thumbnail go'>
                                <img class='image'>
                            </a>
                        </div>
                        <div class='col-sm-6 col-md-8'>
                            <div class='description'></div>
                        </div>
                    </div>
                </div>
                <div class='modal-footer'>
                    <a id='paper' type='button' class='btn btn-default external' style='display:none'>Paper</a>
                    <a type='button' class='btn btn-default go'>Go</a>
                    <button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id='content'>
        <div class='container-fluid'>
            <div class='pull-right'>
                <button type='button' class='btn btn-default navbar-btn' title='Synchronize simulations' id='sim-sync'>
                <i class='fa fa-refresh'></i>
            </button>
                <a type='button' class='btn btn-default navbar-btn' title='Configuation' href="./templates/config.html">
                <i class='fa fa-cog'></i>
            </a>
                <button type='button' class='btn btn-default navbar-btn' onclick='window.close()'>
                    <span class='glyphicon glyphicon-remove'></span>
                </button>
            </div>
        </div>

        <div class='container'>
            <div class='jumbotron'>
                <h1 id="title"></h1>
                <p id="subtitle"></p>
                <p class='hide'>
                    <a class='btn btn-primary btn-lg external' href='https://www.npmjs.com/package/nest-desktop' role='button'>Learn more</a>
                </p>
            </div>
        </div>

        <div id='jumbotron-bg' class='background'></div>
        <div id='simulations' class='container'></div>
</body>

<script>
    window.jQuery = $ = require('jquery')
    require('bootstrap');
    const shell = require('electron').shell;
    const path = require('path');
    const fs = require('fs');

    window.app = require('./app');
    app.db.init()
    app.sync.init()
    app.sync.remoteDB()
    app.request.server_check()
    var configApp = app.config.app();
    $('title').html(configApp.title)
    $('#title').html(configApp.title)
    $('#subtitle').html(configApp.subtitle)
    $('.external').on('click', function(event) {
        event.preventDefault();
        shell.openExternal(this.href);
    });

    var loadSimulations = function() {
        $('#simulations').empty()
        var groups = configApp.simulation.groups;
        var groupIds = groups.map(function(group) {
            $('#simulations').append('<div id="sim-' + group.id + '"></div>')
            $('#sim-' + group.id).append('<h4>' + group.name + ' simulations</h4>')
            $('#sim-' + group.id).append('<div class="row simulation-list"></div>')
            return group.id
        })
        app.db.all().sort({
            name: 1.
        }).exec(function(err, docs) {
            // console.log(docs)
            if (docs.length == 0) return
            docs.map(function(doc) {
                if (groupIds.indexOf(doc.group) == -1) return
                // console.log(doc.group)
                $('#sim-' + doc.group).find('.simulation-list').append(app.renderer.simulationThumbnails(doc))
            })

            // $('[data-toggle='tooltip']').tooltip();
            $('.simulation').on('click', function() {
                $('#simulation-detail').find('.modal-title').html($(this).find('a').attr('title'));
                $('#simulation-detail').find('.description').html($(this).find('.description').html());
                $('#simulation-detail').find('.image').attr('src', $(this).find('img').attr('src'));
                if ($(this).attr('data-doi') == 'undefined') {
                    $('#simulation-detail').find('#paper').hide();
                } else {
                    $('#simulation-detail').find('#paper').attr('href', 'http://dx.doi.org/' + $(this).data('doi')).show();
                }
                $('#simulation-detail').find('.go').attr('href', $(this).find('a').attr('href'));
                $('#simulation-detail').modal('show');
            })
        })
    }

    $('#sim-sync').on('click', () => {
        app.sync.remoteDB()
        setTimeout(loadSimulations, 1000)
    })

    setTimeout(loadSimulations, fs.existsSync(path.join(process.cwd(), configApp.datapath, configApp.db.name + '.db')) ? 1 : 1000)
</script>

</html>
