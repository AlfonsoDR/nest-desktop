<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.css" />
    <link rel="stylesheet" href="./assets/css/styles.css" />
    <title></title>
</head>

<body>
    <nav class="navbar navbar-static-top">
        <div class="container-fluid">
            <div class="navbar-right">
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" title="Menu">
                            <i class="fa fa-bars"></i>
                        </a>
                        <ul class="dropdown-menu" role="menu">
                            <li id="sim-sync">
                                <a href="#">
                                    <i class="fa fa-refresh"></i> Synchronize simulations
                                </a>
                            </li>
                            <li>
                                <a href="./templates/config.html">
                                    <i class="fa fa-wrench"></i> Configurations
                                </a>
                            </li>
                            <li>
                                <a onclick="window.close()">
                                    <i class="fa fa-times"></i> Close app
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="jumbotron">
            <h1 id="title"></h1>
        </div>
    </div>

    <div id="jumbotron-bg" class="background"></div>
    <div id="simulations" class="container">
        <div id="simulation-list" class="col-md-5"></div>
        <div id="simulation-details" class="col-md-7"></div>
    </div>
</body>

<script>
    window.$ = window.jQuery = require('jquery');
    require('bootstrap');
    const shell = require('electron').shell;
    const path = require('path');
    const fs = require('fs');

    window.app = require('./app');
    app.config.init()
    app.db.init()
    app.sync.init()
    app.sync.remoteDB()
    app.request.server_check()
    var configApp = app.config.app();
    $('title').html(configApp.title)
    $('#title').html(configApp.title)
    $('.external').on('click', function(event) {
        event.preventDefault();
        shell.openExternal(this.href);
    });

    $('#sim-sync').toggle(configApp.db.remote.host != '')

    var loadSimulations = function() {
        $('#simulation-list').empty()
        var groups = configApp.simulation.groups;
        var groupIds = groups.map(function(group) {
            if (group.visible == false) return
            $('#simulation-list').append('<div id="sim-' + group.id + '"></div>')
            $('#sim-' + group.id).append('<h4>' + group.name + ' simulations</h4>')
            $('#sim-' + group.id).append('<div class="row simulation-list list-group"></div>')
            return group.id
        })
        app.db.all().sort({
            name: 1.
        }).exec(function(err, docs) {
            // console.log(docs)
            if (docs.length == 0) return
            docs.map(function(doc) {
                if (groupIds.indexOf(doc.group) == -1) return
                // console.log(doc.group)
                $('#sim-' + doc.group).find('.simulation-list').append(app.renderer.simulation.list(doc))
                $('#' + doc._id).mouseover(() => {
                    $('#simulation-details').html(app.renderer.simulation.details(doc))
                })
                app.protocol.count(doc._id).exec((err, count) => {
                    if (count == 0) return
                    $('#' + doc._id).find('.badge').append(count)
                    app.protocol.latest(doc._id).exec((err, protocols) => {
                        var href = $('#' + doc._id).attr('href');
                        $('#' + doc._id).attr('href', (href + '&protocol=' + protocols[0]._id))
                    })
                })
            })
        })
    }

    $('#sim-sync').on('click', () => {
        app.sync.remoteDB()
        setTimeout(loadSimulations, 1000)
    })

    setTimeout(loadSimulations, fs.existsSync(path.join(app.dataPath, configApp.db.name + '.db')) ? 1 : 1000)
</script>

</html>
