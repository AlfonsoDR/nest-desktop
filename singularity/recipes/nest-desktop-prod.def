Bootstrap: docker
From: ubuntu:18.04

%labels
  AUTHOR Sebastian Spreizer <spreizer@web.de>
  VERSION 1.5.0

%setup
  mkdir -p /opt/nest-desktop/

%files
  ./dist/nest-desktop /opt/nest-desktop/app
  ./singularity/bin /opt/nest-desktop/bin

%post
  apt update && apt install -y \
  build-essential \
  cmake \
  curl \
  cython3 \
  git \
  libgsl-dev \
  libltdl-dev \
  libncurses5-dev \
  libreadline-dev \
  python3-all-dev \
  python3-numpy \
  python3-pip \
  wget

  curl -sL https://deb.nodesource.com/setup_10.x | bash -
  apt update && apt install -y nodejs
  npm install --global --unsafe-perm=true pouchdb-server pouchdb-adapter-leveldb

  pip3 install uwsgi flask flask-cors
  git clone https://github.com/babsey/nest-server.git /opt/nest-server

  cd /tmp/
  if [ ! -f "v2.16.0.tar.gz" ]; then
    wget https://github.com/nest/nest-simulator/archive/v2.16.0.tar.gz
  fi
  tar -zxf v2.16.0.tar.gz

  rm -rf /tmp/nest-build; mkdir /tmp/nest-build; cd /tmp/nest-build
  cmake -DCMAKE_INSTALL_PREFIX:PATH=/opt/nest-simulator/ -Dwith-python=3 /tmp/nest-simulator-2.16.0
  make; make install

  rm -rf /tmp/nest-build /tmp/nest-simulator-2.16.0
  chmod +x /opt/nest-desktop/bin/nest-*


%environment
  # NEST is installed here. When you relocate NEST, change this variable.
  export NEST_INSTALL_DIR=/opt/nest-simulator

  # NEST finds standard *.sli files $NEST_DATA_DIR/sli
  export NEST_DATA_DIR=$NEST_INSTALL_DIR/share/nest

  # NEST finds help files $NEST_DOC_DIR/help
  export NEST_DOC_DIR=$NEST_INSTALL_DIR/share/doc/nest

  # The path where NEST looks for user modules.
  export NEST_MODULE_PATH=$NEST_INSTALL_DIR/lib64/nest

  # The path where the PyNEST bindings are installed.
  export NEST_PYTHON_PREFIX=$NEST_INSTALL_DIR/lib/python3.6/site-packages
  export PYTHONPATH=$NEST_PYTHON_PREFIX:$PYTHONPATH

  # Make nest / sli /... executables visible.
  export PATH=$NEST_INSTALL_DIR/bin:$PATH

  # NEST Desktop environments
  export NESTDESKTOP_PATH=/opt/nest-desktop
  export PATH=$NESTDESKTOP_PATH/bin:$PATH

  # The path where NEST stores data
  export NESTDESKTOP_DATA_DIR=$HOME/.nest-desktop

%runscript
  nest-db-server start &
  nest-server start &
  nest-desktop start &

%apprun status
  nest-desktop status
  nest-server status
  nest-db-server status

%apprun stop
  nest-desktop stop
  nest-server stop
  nest-db-server stop
